=========================================================================================================================================================

✅ Goal
After every Jenkins pipeline run, send a success/failure email using Zentyal Mail Server.
💡 This works fully offline over LAN, no internet required

#🧠 Conceptual Flow Diagram

[Jenkins (Docker) on S2]
       |
       |  SMTP Email via LAN
       v
[Zentyal Mail Server (VirtualBox) on S1]
       |
       v
[isrd-admin@isrd.cair.drdo] — Receives Jenkins build notifications


| Server | Role                                                   | OS/Platform        |
| ------ | ------------------------------------------------------ | ------------------ |
| **S1** | Zentyal Mail Server (Postfix + Dovecot + Webmail/SOGo) | VirtualBox Ubuntu  |
| **S2** | Jenkins (CI Server, Dockerized)                        | Ubuntu with Docker |

#This must be a real mail user in Zentyal, and it should match the authenticated SMTP account.


[Jenkins job runs] ──▶ Send mail using:
   FROM: jenkins@zentyal.lan
     TO: isrd-admin@zentyal.lan
         |
         └─🧾 Receiver mailbox (on Zentyal, viewable via SOGo or IMAP client)






--------------------------------------------------------------------------------------------------------------------------------------------------
						#Zentyal Mail Server Configuration (S1)
				Sending Jenkins email notifications via a Zentyal mail server over LAN


#✅ OVERALL ARCHITECTURE

+------------------+                         +----------------------------+
| Server 2 (Host)  |                         | Server 1 (Host)            |
| Ubuntu (Base OS) |                         | Ubuntu (Base OS)           |
| └── Docker Engine|                         | └── VirtualBox             |
|     └─ Jenkins   |                         |     └─ Zentyal Mail Server |
|     └─ NGINX     |                         |        (SMTP+IMAP)         |
+------------------+                         +----------------------------+
        |                                                  ^
        |     LAN Network (192.168.3.0/24)                 |
        |                                                  |
        +--------------------------------------------------+


#✅ Updated Network Layout (Your LAN)

--------------------------------------------------------------------------------
| Component             | IP Address    | Role                                 |
| --------------------- | ------------- | ------------------------------------ |
| **Server 1 (Ubuntu)** | `192.168.3.1` | Runs **Tuleap** (in Docker)          |
| **Zentyal (VM)**      | `192.168.3.2` | Runs **Mail Server** (SMTP/IMAP)     |
| **Server 2 (Ubuntu)** | `192.168.3.3` | Runs **Jenkins + NGINX** (in Docker) |
--------------------------------------------------------------------------------


#✅ How Jenkins (Docker on Server2) Talks to Zentyal (192.168.3.2)
🔗 Flow of Email from Jenkins to Zentyal:

[Jenkins Docker container]
        │
        ▼
[Docker Bridge Network]
        │
        ▼
[Server2 Host Network: 192.168.3.3]
        │
        ▼
[LAN switch/router]
        │
        ▼
[Zentyal at 192.168.3.2 (SMTP)]


#✅ Required Setup for This to Work
🔧 On Zentyal (192.168.3.2):
Virtual domain: isrd.cair.drdo

Users: jenkins, isrd-admin

Enable services:

✅ SMTP

✅ IMAP

✅ SMTP authentication

✅ TLS optional


#🧪 On Server2 (192.168.3.3, Jenkins host)
From inside Jenkins container, test access to Zentyal:

docker exec -it jenkins ping 192.168.3.2
docker exec -it jenkins telnet 192.168.3.2 25


#✅ Jenkins Configuration (GUI):
In Jenkins → Manage Jenkins → Configure System → Extended Email Notification:

| Setting                  | Value                    |
| ------------------------ | ------------------------ |
| SMTP server              | `192.168.3.2`            |
| SMTP port                | `25`                     |
| Use SMTP authentication? | ✅ Yes                  |
| Username                 | `jenkins@isrd.cair.drdo` |
| Password                 | `cair@123`               |
| Use SSL                  | ❌ No                    |
| Use TLS                  | ✅ Yes                   |
| Default domain suffix    | `@isrd.cair.drdo`        |
| System admin email       | `jenkins@isrd.cair.drdo` |

#✅ Optional: Resolve by hostname (zentyal.isrd.cair.drdo)
If you want Jenkins to connect using zentyal.isrd.cair.drdo instead of 192.168.3.2:

In docker-compose.yml for Jenkins:
extra_hosts:
  - "zentyal.isrd.cair.drdo:192.168.3.2"


#🧪 Final Test Scenario
--From Jenkins GUI:

--Send a test mail from jenkins@isrd.cair.drdo

--To: isrd-admin@isrd.cair.drdo

--Zentyal will deliver to isrd-admin mailbox

--Login to: https://192.168.3.2/SOGo

Username: isrd-admin

Password: cair@123

✅ See the test email there


docker exec -it jenkins ping zentyal.isrd.cair.drdo



















#✅ HOW IT WORKS (Jenkins ➝ Zentyal Mail)
#1. Zentyal as External SMTP Server
Zentyal Mail Server acts like an external SMTP mail relay inside your LAN. It's not inside Docker, but that's perfectly fine — Docker containers can talk to outside systems via LAN.

Zentyal handles:

SMTP (Send mail)

IMAP (Read mail)

Authentication

TLS optional

Jenkins (inside Docker) will connect to Zentyal via IP 192.168.3.3:25 using STARTTLS + authentication.


#2. Jenkins Configuration Sends Emails via Zentyal
Jenkins inside Docker:

Uses Email Extension Plugin

Configured via:

SMTP server: 192.168.3.3

Port: 25

Auth: jenkins@isrd.cair.drdo / cair@123

TLS: ✅ Yes

SSL: ❌ No

Reply-to: jenkins@isrd.cair.drdo

Sends test email to: isrd-admin@isrd.cair.drdo

✅ This works because Jenkins container can reach Zentyal server on LAN directly.
[Jenkins Container] → [Docker Bridge Network] → [Host Network Interface] → [LAN] → [Zentyal at 192.168.3.3]



#3. Zentyal Receives Mail, Stores in Mailbox
Zentyal will deliver the email to the correct virtual domain mailbox (/var/vmail/...).

You can verify it by logging into SOGo Webmail 


#4.✅ docker-compose.yml — Do You Need to Modify?
✅ Only one line is needed inside the jenkins service to help with name resolution (optional if you're using IP directly):
extra_hosts:
  - "zentyal.isrd.cair.drdo:192.168.3.2"


#✅ Summary (Full Workflow)
---------------------------------------------------------------------------------------------------------------------
| Step | Action                                                                                                     |
| ---- | ---------------------------------------------------------------------------------------------------------- |
| 1️⃣  | Zentyal (in VirtualBox) is configured with domain `isrd.cair.drdo` and users like `jenkins`, `isrd-admin`. |
| 2️⃣  | Zentyal Mail → SMTP + IMAP enabled, TLS optional.                                                          |
| 3️⃣  | Jenkins container (on Ubuntu Server 2) connects via LAN to `192.168.3.3:25` with authentication.           |
| 4️⃣  | Jenkins sends test/build emails to `isrd-admin@isrd.cair.drdo`.                                            |
| 5️⃣  | Zentyal receives and stores mail in admin mailbox.                                                         |
| 6️⃣  | Admin verifies via SOGo or IMAP client.                                                                    |
--------------------------------------------------------------------------------------------------------------------







--------------------------------------------------------------------------------------------------------------------------------------------------
								#process
								 ZENTYAL

Navigate to Mail > Virtual Domains in the Zentyal interface
#Mail → Virtual Domains → Add
------------------------------------
| Field       | Value              |
| ----------- | ------------------ |
| Domain name | `isrd.cair.drdo` ✅|
------------------------------------

👉 This is the domain used for email addresses like jenkins@isrd.cair.drdo

✅ Click Add Domain


#Create Mail Users
You'll need two users: one for Jenkins to send from and another for the administrator to receive notifications.

#Create Users for Jenkins & Admin
Users and Computers → Users → Add

#➤ Create Jenkins Mail Sender:
--------------------------------------------------------
| Field    | Value                                     |
| -------- | ----------------------------------------- |
| Username | `jenkins`                                 |
| Password | `cair@123`                                |
| Email    | Will auto-become `jenkins@isrd.cair.drdo` |
--------------------------------------------------------

#➤ Create Admin Mail Receiver:
-----------------------------------------------------------
| Field    | Value                                        |
| -------- | -------------------------------------------- |
| Username | `isrd-admin`                                 |
| Password | `cair@123`                                  |
| Email    | Will auto-become `isrd-admin@isrd.cair.drdo` |
-----------------------------------------------------------

#Enable SMTP + IMAP in Mail Settings
Ensure your Zentyal server is set up to send and receive mail.

Go to Mail → General

✅ SMTP Service is enabled

✅ IMAP/POP3 Service is enabled

✅ Authentication is enabled for SMTP

✅ TLS is optional but recommended


#Access SOGo Webmail (Verification)

Go to: https://192.168.3.2/SOGo

Login as:

User: isrd-admin

Password: caiar@123

#✅ You should see the inbox of isrd-admin@isrd.cair.drdo




--------------------------------------------------------------------------------------------------------------------------------------------------
							#✅ Jenkins Configuration (S2)

Update docker-compose.yml
version: '3.8'
services:
  jenkins:
    # ... other Jenkins configurations ...
    extra_hosts:
      - "zentyal.isrd.cair.drdo:192.168.3.3" # Add this line
    # ... rest of your Jenkins service definition ...


#Configure Jenkins Mail from GUI
This is the crucial step to tell Jenkins how to connect to your Zentyal server.

Access your Jenkins dashboard.

🧩 STEP 1: Install Email Plugins

Go to:
Manage Jenkins → Plugin Manager → Available

Search and install:

---Email Extension Plugin

---Mailer Plugin


#Restart Jenkins if needed.


Navigate to Manage Jenkins > Configure System.

Scroll down to the Extended E-mail Notification section (or similar, depending on your email plugin). If you don't see this, you might need to install the Email Extension Plugin via Manage Jenkins > Plugins.

--SMTP server: 192.168.3.3 (Your Zentyal server's IP address)

--Default user e-mail suffix:  @isrd.cair.drdo

--Use SMTP Authentication?: ✅ Yes 

Username: jenkins@isrd.cair.drdo

Password: cair@123

--Use SSL: ❌ No (We are using TLS)

--Use TLS: ✅ Yes

--SMTP port: 25

--Reply-To Address: jenkins@isrd.cair.drdo (This is the email address that recipients will reply to if they hit "reply")

--Charset: UTF-8 (This is generally a good default)

#Test configuration by sending test e-mail
Recipient (for test email): isrd-admin@isrd.cair.drdo

Click the Test configuration button.


#Important: Click the Test Configuration button. Jenkins will attempt to send a test email.

------------------------------------------------------------------------------------------------------------------------------------------------
#JENKINS

1.  For https://jenkins.isrd.cair.drdo:8443/manage/configure (System Configuration):

# System Admin e-mail address: jenkins@isrd.cair.drdo

#note
This address is typically used as the "From" address for system-generated emails (like build notifications, if not overridden by the Extended E-mail Notification plugin) and as the return path for bounce messages. It represents Jenkins itself.



2. For https://jenkins.isrd.cair.drdo:8443/user/admin/account/ (Admin User's Profile Configuration):

# E-mail address: isrd-admin@isrd.cair.drdo

#note
This is the personal email address for the admin user in Jenkins. This is where notifications specifically directed to the Jenkins admin user (e.g., failed login attempts, critical system alerts, or specific job notifications configured to go to the build initiator) would be sent. Since isrd-admin is your designated receiver, this is the correct address for the admin user's profile.



--System-wide email (manage/configure): jenkins@isrd.cair.drdo

--Admin user's personal email (user/admin/account): isrd-admin@isrd.cair.drdo

--------------------------------------------------------------------------------------------------------------------------------------------------

#note
#Add in /etc/hosts of the Docker host
#Or use extra_hosts: in docker-compose.yml
extra_hosts:
  - "zentyal.isrd.cair.drdo:192.168.3.2"



----------------------------------------------------------------------------------------------------------------------------------------------
#✅ Minimal Setup for Testing Jenkins + Zentyal Email Flow
🖥️ Server 1 (Physical Host)
--OS: Ubuntu

Running:

--Docker

--Jenkins (Docker container)

--NGINX (Docker container)

--VirtualBox

--Zentyal (Mail server VM)



#[Jenkins (inside Docker)]
        │
     SMTP Email
        │
[Zentyal Mail Server (inside VirtualBox)]

--------------------------------------------------------------------------------------------------------------------------------------------------

sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
javax.net.ssl.SSLHandshakeException

sun.security.provider.certpath.SunCertPathBuilderException:
unable to find valid certification path to requested target

#🧠 Why this happens:
Your Zentyal mail server uses a self-signed CA (internal Certificate Authority).

Jenkins (running in Docker) uses Java, and Java has its own truststore (cacerts) that does not trust your internal CA by default.

So when Jenkins tries to connect to Zentyal over SMTP with STARTTLS or SSL → Java refuses to trust the cert → handshake fails.

#!/bin/bash

# Auto-map nginx container IP in /etc/hosts (avoid duplicate entries)
NGINX_IP=$(getent hosts jenkins-nginx | awk '{ print $1 }')
grep -q "jenkins.isrd.cair.drdo" /etc/hosts || echo "$NGINX_IP jenkins.isrd.cair.drdo" >> /etc/hosts

# Trust Internal CA
cp /etc/ssl/certs/ca-cert.crt /usr/local/share/ca-certificates/ca-cert.crt
update-ca-certificates

# Import CA cert into Java truststore
keytool -import -noprompt -trustcacerts -alias internal-root-ca \
  -keystore /opt/java/openjdk/lib/security/cacerts \
  -file /etc/ssl/certs//ca-cert.crt \
  -storepass changeit

# Start Jenkins
exec /usr/local/bin/jenkins.sh


docker exec -it <jenkins-container-name> bash

keytool -list -keystore /opt/java/openjdk/lib/security/cacerts -storepass changeit | grep cair























#offical
✅ Zentyal mail server (with HTTPS and custom CA, running on LAN)

✅ Jenkins (inside Docker container, on Ubuntu host, with its own HTTPS certificate from the same CA)

✅ Both systems are LAN-connected and operating in an offline environment.


✅ Goal
Integrate Jenkins with Zentyal mail server so Jenkins can send email notifications using Zentyal as the SMTP relay server over LAN.


#🔧 Prerequisites
---------------------------------------------------------------------------------
| Component                   | Details                                         |
| --------------------------- | ----------------------------------------------- |
| Zentyal SMTP IP             | e.g. `192.168.3.1`                              |
| SMTP Port                   | `25` or `587` (TLS) or `465` (SSL)              |
| Jenkins container IP        | e.g. `172.19.0.5` (check with `docker inspect`) |
| Jenkins hostname            | e.g. `jenkins.isrd.cair.drdo`                   |
| Valid email user on Zentyal | e.g. `jenkins@zentyal-domain.lan` with password |
| Certificate trust           | Jenkins container must trust Zentyal's CA cert  |
---------------------------------------------------------------------------------

#🧩 Step-by-Step Integration: Jenkins → Zentyal Mail (LAN)













|

