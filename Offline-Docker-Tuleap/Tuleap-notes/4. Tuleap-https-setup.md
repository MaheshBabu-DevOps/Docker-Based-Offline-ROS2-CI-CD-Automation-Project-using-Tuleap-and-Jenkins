#########################################‚úÖHTTPS Secure Padlock Setup for Tuleap on Ubuntu Host Machine‚úÖ#######################################


				HTTPS Setup for Tuleap & Jenkins (Using Pre-Generated Certificates from Zentyal


#Two Ubuntu 22.04 servers:

Server 1 (S1): Tuleap (RedHat-based Docker container)

Server 2 (S2): Jenkins (Debian-based Docker container)


#Server 1 - Ubuntu + RedHat-based container

CA/
‚îú‚îÄ‚îÄ ca-cert.crt               # CA Certificate
‚îú‚îÄ‚îÄ ca-public-key.pem         # CA Public Key

(Note: The private key of the CA is likely kept secure by the admin.)

Tuleap/
‚îú‚îÄ‚îÄ tuleap.isrd.cair.drdo-cert.crt         # Tuleap Server Certificate
‚îú‚îÄ‚îÄ tuleap.isrd.cair.drdo-private-key.pem  # Tuleap Private Key
‚îî‚îÄ‚îÄ tuleap.isrd.cair.drdo.p12              # PKCS12 Bundle (cert + key)


/srv/jenkins/jenkins-ssl-setup/certs/
‚îú‚îÄ‚îÄ tuleap.crt.pem              ‚Üê Copy from tuleap.isrd.cair.drdo-cert.crt
‚îú‚îÄ‚îÄ tuleap.key.pem              ‚Üê Copy from tuleap.isrd.cair.drdo-private-key.pem
‚îú‚îÄ‚îÄ zentyal-ca.crt               ‚Üê Copy from ca-cert.crt



#tuleap

/srv/
‚îî‚îÄ‚îÄ tuleap/
    ‚îú‚îÄ‚îÄ .env                      # Tuleap environment variables (MySQL, Redis, etc.)
    ‚îú‚îÄ‚îÄ docker-compose.yaml       # Docker Compose configuration for Tuleap stack
    ‚îî‚îÄ‚îÄ tuleap-ssl-setup/         # TLS/SSL certs and related config
        ‚îú‚îÄ‚îÄ certs/                # Server certificates & private keys (mounted into container)
        ‚îÇ   ‚îú‚îÄ‚îÄ tuleap.crt.pem         ‚úÖ Tuleap server cert (signed by Zentyal CA)
        ‚îÇ   ‚îú‚îÄ‚îÄ tuleap.key.pem         # Tuleap server private key
        ‚îÇ   ‚îú‚îÄ‚îÄ tuleap.p12             # Optional PKCS12 bundle (cert + key)
        ‚îÇ   ‚îú‚îÄ‚îÄ zentyal-ca.crt.pem       # Zentyal CA public certificate (trusted root CA)

        ‚îú‚îÄ‚îÄ ca-trust/                  # Certificates trusted inside the Tuleap container
        ‚îÇ   ‚îú‚îÄ‚îÄ zentyal-ca.crt     # Zentyal CA cert for updating CA trust store
        ‚îÇ   ‚îú‚îÄ‚îÄ jenkins.crt.pem            # Jenkins cert trusted by Tuleap (for mutual trust)
        ‚îÇ   ‚îî‚îÄ‚îÄ localhost.crt.pem      # Optional localhost cert (for local dev/testing)

        ‚îî‚îÄ‚îÄ nginx/                 # NGINX configuration files for TLS termination
            ‚îú‚îÄ‚îÄ tuleap.conf                # Main Tuleap HTTPS NGINX config (using certs above)
            ‚îú‚îÄ‚îÄ tuleap.d/                  # Additional NGINX site configs (optional)
            ‚îú‚îÄ‚îÄ tuleap-managed-global-settings.conf  # Tuleap autogenerated NGINX config
            ‚îî‚îÄ‚îÄ tuleap-plugins/            # Plugin-specific NGINX configs (if any)




#Note:
Using .pem means your certificates and keys are in a universal, text-based format expected by NGINX, Jenkins, and OpenSSL.

The original .crt might not be in the right format or might be binary, so converting to .pem avoids errors and is considered best practice.


1. Prepare Certificate Directory
mkdir -p /srv/tuleap/tuleap-ssl-setup && cd /srv/tuleap/tuleap-ssl-setup
sudo mkdir -p /srv/tuleap/tuleap-ssl-setup/{certs,ca-trust,nginx}
sudo touch .env docker-compose.yaml


2. Prepare the Environment
--Ensure you're working in a production environment with root privileges (via sudo).

--Choose the proper system location for the Tuleap setup:
--Path: /srv/tuleap/
--This ensures proper organization and security.


3. üìÅ Folder Structure After Creating Tuleap Directory
/srv/
‚îî‚îÄ‚îÄ tuleap/
    ‚îú‚îÄ‚îÄ .env                   # Environment variables for Tuleap, MySQL, Redis
    ‚îî‚îÄ‚îÄ docker-compose.yaml    # Docker Compose configuration for all services


$ sudo mkdir -p /srv/tuleap
$ cd /srv/tuleap
$ sudo nano .env          # Create and edit environment file
$ sudo nano docker-compose.yaml  # Create and edit Docker Compose config


4. Open Nano to Create the .env File
sudo nano .env

5. Paste the Following Content into (.env)

# Fully Qualified Domain Name (FQDN) of your Tuleap instance
TULEAP_FQDN="tuleap.isrd.cair.drdo"

# Docker service name
TULEAP_SYS_DBHOST="db"

# Password for MySQL root user. Used during database initialization.
MYSQL_ROOT_PASSWORD="StrongRootPassword123"

# Tuleap application user database password
TULEAP_SYS_DBPASSWD="TuleapAppUserPass456"

# Default admin password for Tuleap web UI login (user: codendi-admin).
SITE_ADMINISTRATOR_PASSWORD="AdminPassword789"

# Email address used by Tuleap to send system emails(The "From" email address used for system notifications (e.g., password reset).)
TULEAP_SYS_EMAIL_ADMIN="tuleap-admin@isrd.cair.drdo.com"

# How Tuleap sends emails: sendmail (for Postfix on host) or smtp (for Gmail, etc).
TULEAP_EMAIL_TRANSPORT="smtp"


#‚úÖ These Redis-related variables are optional but are recommended in a production setup for improved performance, scalability, and session management reliability.

# Use Redis for storing PHP sessions (options: "redis" or leave blank for default file-based sessions)
TULEAP_FPM_SESSION_MODE="redis"

# Hostname of the Redis container. Usually redis
TULEAP_REDIS_SERVER="redis"

# Redis port (default is 6379)--Port Redis listens on.
TULEAP_REDIS_PORT="6379"

# Password to connect to Redis (if you set one).
TULEAP_REDIS_PASSWORD="RedisSecurePassword321"

# Use TLS for Redis? (1 = yes, 0 or leave blank = no)
TULEAP_REDIS_USE_TLS="0"

#save and exit!



6. Create compose.yaml for Tuleap (Production)
üìÅ Path:
/srv/tuleap/docker-compose.yaml

üìå Purpose:
Defines and configures three services: tuleap, mysql, and redis, using environment variables from .env.

üìù Command to Create the File
cd /srv/tuleap
sudo nano docker-compose.yaml

version: '3.8'

services:
  tuleap:
    image: tuleap/tuleap-community-edition:latest
    hostname: ${TULEAP_FQDN}
    container_name: tuleap
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "22:22"
    volumes:
      - tuleap-data:/data
    depends_on:
      - db
      - redis
    environment:
      - TULEAP_FQDN=${TULEAP_FQDN}
      - TULEAP_SYS_DBHOST=${TULEAP_SYS_DBHOST}
      - TULEAP_SYS_DBPASSWD=${TULEAP_SYS_DBPASSWD}
      - SITE_ADMINISTRATOR_PASSWORD=${SITE_ADMINISTRATOR_PASSWORD}
      - DB_ADMIN_USER=root
      - DB_ADMIN_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - TULEAP_SYS_EMAIL_ADMIN=${TULEAP_SYS_EMAIL_ADMIN}
      - TULEAP_EMAIL_TRANSPORT=${TULEAP_EMAIL_TRANSPORT}
      - TULEAP_FPM_SESSION_MODE=${TULEAP_FPM_SESSION_MODE}
      - TULEAP_REDIS_SERVER=${TULEAP_REDIS_SERVER}
      - TULEAP_REDIS_PORT=${TULEAP_REDIS_PORT}
      - TULEAP_REDIS_PASSWORD=${TULEAP_REDIS_PASSWORD}
      - TULEAP_REDIS_USE_TLS=${TULEAP_REDIS_USE_TLS}
    networks:
      - shared-network

  db:
    image: mysql:8.0
    container_name: tuleap_db
    restart: always
    command: ["--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci", "--sql-mode=NO_ENGINE_SUBSTITUTION"]
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - shared-network

  redis:
    image: redis:latest
    container_name: tuleap_redis
    restart: always
    command: redis-server --requirepass ${TULEAP_REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - shared-network

volumes:
  tuleap-data:
  db-data:
  redis-data:

networks:
  shared-network:
    driver: bridge

#save and exit!

$ docker-compose up -d

# Update /etc/hosts to Map Hostname
$ sudo nano /etc/hosts

‚û°Ô∏è Add the line:
127.0.0.1	tuleap.isrd.cair.drdo   #local machine that tuleap.isrd.cair.drdo points to localhost (127.0.0.1)

‚úÖ Way in Production (Multi-Server):
192.168.3.1	tuleap.isrd.cair.drdo


üîπ Monitor Logs

docker-compose logs -f tuleap
docker-compose logs
docker volume ls
docker network ls
docker network inspect <tuleap-setup_default>



#üîëIntial password for tuleap 
AdminPassword789

#Browser access
https://tuleap.isrd.cair.drdo/   

‚ö†Ô∏è Note: The browser may show ‚ÄúNot Secure‚Äù due to self-signed SSL certificates.




--------------------------------------------------------------HTTPS-------------------------------------------------------------------------------

sudo mkdir -p /srv/tuleap/tuleap-ssl-setup/{certs,ca-trust,nginx}
# Copy CA cert
sudo cp ca-cert.crt /srv/tuleap/tuleap-ssl-setup/ca-trust/zentyal-ca.crt
sudo cp jenkins.crt.pem /srv/tuleap/tuleap-ssl-setup/ca-trust               #Tuleap trusts Jenkins server certificate


# Copy Tuleap certs
sudo cp tuleap.isrd.cair.drdo-cert.crt /srv/tuleap/tuleap-ssl-setup/certs/tuleap.crt.pem
sudo cp tuleap.isrd.cair.drdo-private-key.pem /srv/tuleap/tuleap-ssl-setup/certs/tuleap.key.pem
sudo cp ca-cert.crt /srv/tuleap/tuleap-ssl-setup/certs/zentyal-ca.crt.pem


2. Set Proper Permissions

sudo chmod 644 /srv/tuleap/tuleap-ssl-setup/certs/*.pem
sudo chmod 600 /srv/tuleap/tuleap-ssl-setup/certs/tuleap.key.pem


3. Update System CA Trust
# Remove old CA(cleanup and refresh)
sudo rm /usr/local/share/ca-certificates/<>
sudo update-ca-certificates --fresh

# Add Zentyal CA(UBUNTU--HOST--SERVER-1)
sudo cp ca-cert.crt /usr/local/share/ca-certificates/zentyal-ca.crt
sudo update-ca-certificates
ls /etc/ssl/certs/zentyal-ca.pem


#copy the nginx dir from container to (host)
sudo docker cp tuleap:/etc/nginx/conf.d/tuleap.conf   /srv/tuleap/tuleap-ssl-setup/nginx


3. Modify NGINX Configuration

server {
    listen 443 ssl;
    server_name tuleap.isrd.cair.drdo;

    ssl_certificate /etc/pki/undercloud-certs/tuleap.crt.pem;
    ssl_certificate_key /etc/pki/undercloud-certs/tuleap.key.pem;
    ssl_trusted_certificate /etc/pki/undercloud-certs/zentyal-ca.crt.pem;
    

#üß©modify the tuleap docker-compose file(host)
4. Update Docker Compose

volumes:
  - /srv/tuleap/tuleap-ssl-setup/certs:/etc/pki/undercloud-certs
  - /srv/tuleap/tuleap-ssl-setup/nginx:/etc/nginx/conf.d
  - /srv/tuleap/tuleap-ssl-setup/ca-trust:/etc/pki/ca-trust/source/anchors


#note:-
- Top volumes section: Maps volumes to container paths.
- Bottom volumes section: Defines named volumes used in the top section.
 defines named volumes. It's declaring the named volumes used in the top volumes section, allowing Docker to manage them.
 

5. 
cd /srv/tuleap
docker-compose down
docker-compose up -d


#proxy
###webhook--CI IN TULEAP-----------1

##tuleap proxy setup 
docker exec -it tuleap bash
#vi /etc/environment
NO_PROXY=jenkins.isrd.cair.drdo

# note (docker-compose down and up  also connection will happening)


#cd /etc/tuleap/conf
#vi local.inc
// set no proxy to excute jenkins
putenv('no_proxy=jenkins.isrd.cair.drdo');

//disable proxy settings for tuleap
$http_proxy = '';
$https_proxy = '';
$sys_proxy = '';


#host
export no_proxy="jenkins.isrd.cair.drdo,localhost.127.0.0.1"
git config --global --unset http.proxy
git config --global --unset https.proxy
export http_proxy=""
export https_proxy=""


#docker restart tuleap


 
 
============================================================================================================================================================================================================================================
#jenkins.crt process(tuleap and jenkins)

1. Jenkins must trust Tuleap server certificate (handled by importing Tuleap's certificate into Jenkins' Java truststore)-tuleap.crt
Test Jenkins ‚Üí Tuleap Connection
docker exec -it jenkins curl -vk https://tuleap.isrd.cair.drdo

#SSL certificate verify ok.
#Check Truststore
docker exec -it jenkins \
keytool -list -keystore /opt/java/openjdk/lib/security/cacerts -storepass changeit | grep tuleap


2. Jenkins must run behind a reverse proxy that does TLS termination (handled by NGINX in your jenkins.conf file)


3. Tuleap must trust Jenkins server certificate 
Obtain the Jenkins server's public certificate (e.g., jenkins.isrd.cair.drdo-cert.crt).

$ openssl s_client -connect jenkins.isrd.cair.drdo:443 -showcerts </dev/null 2>/dev/null | openssl x509 -outform PEM > jenkins.crt

or
# Get Jenkins cert
openssl s_client -connect jenkins.isrd.cair.drdo:443 -showcerts </dev/null | \
  awk '/BEGIN CERTIFICATE/,/END CERTIFICATE/{ if(++n==1) print }' > jenkins.crt


# Copy Jenkins cert to Tuleap container's trusted anchors
sudo cp jenkins.crt /srv/tuleap/tuleap-ssl-setup/ca-trust/jenkins.crt

# In docker-compose.yml, mount this folder as:
volumes:
  - /srv/tuleap/tuleap-ssl-setup/ca-trust:/etc/pki/ca-trust/source/anchors

# Inside Tuleap container (or via entrypoint script), run:
update-ca-trust extract


or
#Step 1: Create a custom entrypoint script (on your host machine)
/srv/tuleap/tuleap-entrypoint.sh

#!/bin/bash
# Custom Tuleap entrypoint script to update CA trust

# Update CA trust so Tuleap trusts new certs added to /etc/pki/ca-trust/source/anchors
update-ca-trust extract

# Then run the original Tuleap entrypoint with any passed args
exec /entrypoint.sh "$@"


$ sudo chmod +x /srv/tuleap/tuleap-entrypoint.sh


#services:
  tuleap:
    volumes:
      - ./tuleap-entrypoint.sh:/tuleap-entrypoint.sh:ro
      - /srv/tuleap/tuleap-ssl-setup/ca-trust:/etc/pki/ca-trust/source/anchors
    entrypoint: ["/tuleap-entrypoint.sh"]


#volumes:
  - /srv/tuleap/tuleap-ssl-setup/certs:/etc/pki/tuleap-certs
  - /srv/tuleap/tuleap-ssl-setup/ca-trust:/etc/pki/ca-trust/source/anchors
  - ./tuleap-entrypoint.sh:/tuleap-entrypoint.sh
  
=================================================================================================================================================

#Check Certificate Chain:
openssl s_client -connect tuleap.isrd.cair.drdo:443 -servername tuleap.isrd.cair.drdo -showcerts
openssl s_client --connect  tuleap.isrd.cair.drdo:443
docker exec -it tuleap curl -vk https://tuleap.isrd.cair.drdo
openssl x509 -in /etc/pki/ca-trust/source/anchors/jenkins.crt -text -noout	 #Verify Jenkins‚Äô Certificate Details
curl -vk https://jenkins.isrd.cair.drdo						#Test Without Certificate Validation (Debugging)


#Test HTTPS Connection to Jenkins
curl -v --cacert /etc/pki/ca-trust/source/anchors/jenkins.crt https://jenkins.isrd.cair.drdo


#Browser Test:
Import ca-cert.crt into your browser's trusted certificates

Visit https://tuleap.isrd.cair.drdo - should show valid HTTPS


#note:-
Adding the ca-cert.crt to your browser's trusted certificates because:

- Your browser doesn't inherently trust the Zentyal CA.
- By importing the CA certificate, you're telling your browser to trust any certificates issued by that CA.
- This allows your browser to trust the Tuleap server certificate, which was issued by the Zentyal CA.

This step is necessary to avoid certificate warnings or errors when accessing https://tuleap.isrd.cair.drdo in your browser.



#üõ† Troubleshooting
# Check container logs
docker-compose logs tuleap

# Verify certificate paths in container
docker exec -it tuleap ls -l /etc/pki/undercloud-certs/

#Verify Certificate Chain:

openssl verify -CAfile /srv/tuleap/tuleap-ssl-setup/certs/zentyal-ca.crt.pem \
  /srv/tuleap/tuleap-ssl-setup/certs/tuleap.crt.pem
  
#Check Container Certificates
docker exec tuleap ls -la /etc/pki/tuleap-certs/
docker exec tuleap update-ca-trust check



